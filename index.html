<!DOCTYPE html>
<meta charset="utf-8" />
<script src="//d3js.org/d3.v4.min.js" charset="utf-8"></script>
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.min.js"
  charset="utf-8"
></script>
<script src="https://cdn.jsdelivr.net/gh/holtzy/D3-graph-gallery@master/LIB/d3.layout.cloud.js"></script>
<link rel="shortcut icon" href="/favicon.ico" />

<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>

<html>
  <style type="text/css">
    @font-face {
      font-family: "Twentieth Century Medium";
      src: url("fonts/TwentiethCenturyforKenmoreMedium.ttf") format("truetype");
    }
    @font-face {
      font-family: "Twentieth Century Semi Bold";
      src: url("fonts/TwentiethCenturyforKenmoreSemibold.ttf")
        format("truetype");
    }
    @font-face {
      font-family: "Twentieth Century Light";
      src: url("fonts/TwentiethCenturyforKenmoreLight.ttf") format("truetype");
    }
    @font-face {
      font-family: "Twentieth Century Bold";
      src: url("fonts/TwentiethCenturyforKenmoreBold.ttf") format("truetype");
    }
    p.customfont {
      font-family: "Twentieth Century Medium", "Twentieth Century Semi Bold",
        "Twentieth Century Light", "Twentieth Century Bold";
    }
  </style>

  <style>
    .wcs-title {
      margin: 0;
      padding: 0px;
      text-align: center;
      position: sticky;
    }

    .subtitle {
      margin: 0;
      padding: 0px;
      text-align: center;
    }

    .line-break {
      background: #ececec;
      width: 1000px;
      height: 3px;
      margin: 3em auto;
    }

    #grid {
      row-gap: 100px;
    }

    #words {
      font-family: "Twentieth Century Light";
    }

    footer {
      font-family: "Twentieth Century Light";
      padding: 50px;
    }

  </style>
  <head> </head>
  <body>
    <div class="wcs-title">
      <div class="container text-left">
        <div class="row">
          <div class="col-sm-1" style="padding: 0px; margin-bottom: -30px">
            <img src="images/world_globe.png" alt="logo" class="world-logo" />
          </div>
          <div class="col-sm-11" style="padding: 0px">
            <h1
              style="font-family: 'Twentieth Century Medium'; font-size: 48px"
            >
              World <span style="color: #95e1d3">C</span
              ><span style="color: #8ac4d0">o</span
              ><span style="color: #fce38a">l</span
              ><span style="color: #ff75a0">o</span
              ><span style="color: #845ec2">r</span> Survey
            </h1>
          </div>
        </div>
      </div>
    </div>

    <div class="subtitle">
      <div class="container text-left">
        <div class="row">
          <div class="col-sm-11" style="padding: 0px">
            <h2 style="font-family: 'Twentieth Century Light'; font-size: 24px">
              110 UNWRITTEN LANGUAGES, EACH 24 NATIVE SPEAKERS
            </h2>
          </div>
          <div class="row" style="padding: 0px">
            <p style="font-family: 'Twentieth Century Light'; font-size: 16px">
              WCS was initiated in the late 1970s to investigate how native
              speakers around the world classify colors. Within each unwritten
              language, native speakers were asked to name each of the 330
              Munsell chips randomly.
            </p>
          </div>
          <div class="row">
            <div class="line-break"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <p
        style="
          text-align: center;
          color: grey;
          font-family: 'Twentieth Century Light';
        "
      >
        Scroll over a color to see the word cloud update!
      </p>
      <div style="text-align: center" id="grid"></div>
      <div style="text-align: center" id="words"></div>
    </div>

    <div class = "row">
      <div class = "line-break"></div>
    </div>

    <!-- Create an element where the map will take place -->
    <div class = "map" style="text-align:center">
      <svg id="my_dataviz" width="1000" height="800"></svg>  
    </div>

    <footer class="container-fluid text-center">
      <div class="row">
        <div class="line-break"></div>
      </div>
      <div class="row">
        <div class="col-sm-12">
          <h4
            style="
              font-family: 'Twentieth Century Light';
              font-size: 24px;
              margin-bottom: 0px;
            "
          >
            SUPPORT
          </h4>
        </div>
      </div>

      <div class="row">
        <div class="col-sm-4">
          <a href="https://www.kaggle.com/jboysen/color-survey?select=dict.txt "
            >Dataset</a
          >
        </div>
        <div class="col-sm-4">
          <a href="https://www.cufonfonts.com/font/twentieth-century">Fonts</a>
        </div>
        <div class="col-sm-4">
          <a
            href="https://github.com/d3/d3-scale-chromatic/blob/master/README.md"
            >Color Grid Link TBD</a
          >
        </div>
        <div class="col-sm-4">
          <a href="https://www.jing.fm/iclipt/xbioo/">Logo</a>
        </div>
      </div>
    </footer>
  </body>
  <script src="js/loadData.js"></script>
  <script>
    //*********************************************************
    d3.queue()
      .defer(d3.csv, "data/colors.csv")
      .defer(d3.csv, "data/languages.csv")
      .defer(d3.csv, "data/language_term_dict.csv")
      .defer(d3.csv, "data/chip_term_dict.csv")
      .defer(d3.csv, "data/speakers.csv")
      .await(
        (error, mycolor, languages, langTermDict, chipTermDict, speakers) => {
          let termAbbrevTermDict = getTermAbbrevToTermDict(langTermDict);

          var color = mycolor[Math.floor(Math.random() * 330)];
          var colorData = getDataByColor(
            color["L*"],
            color["a*"],
            color["b*"],
            mycolor,
            chipTermDict,
            termAbbrevTermDict
          );
          console.log("color data for given chip ID is");
          console.log(colorData);

          var gridData = getGridData(mycolor);
          console.log("grid data");
          console.log(gridData);

          // var tooltip = d3.select("#words").append("div").style("opacity", 0);
          // .attr("class", "tooltip");

          let mouseOver = function (d) {
            var terms = getDataByColor(
              d.color.l,
              d.color.a,
              d.color.b,
              mycolor,
              chipTermDict,
              termAbbrevTermDict
            );

            var updatedWords = getListofTerms(terms.all_terms);

            // updateWordMap(colorWords);
            updateWordMap(updatedWords);

            // tooltip.style("opacity", 1);

            // .style("stroke", "black")
            // .style("opacity", 1)
            // .html(JSON.stringify(terms));
          };

          let mouseLeave = function (d) {
            var terms = getDataByColor(
              d.color.l,
              d.color.a,
              d.color.b,
              mycolor,
              chipTermDict,
              termAbbrevTermDict
            );

            var updatedWords = getListofTerms(terms.all_terms);

            // updateWordMap(colorWords);
            updateWordMap([]);

            // updateWordMap([]);
            // d3.selectAll(".Country")
            //   .transition()
            //   .duration(200)
            //   .style("opacity", 0.8);
            // d3.select(this)
            //   .transition()
            //   .duration(200)
            //   .style("stroke", "transparent");
          };

          var grid = d3
            .select("#grid")
            .append("svg")
            .attr("width", "1000px")
            .attr("height", "300px");
          // .call(
          //   d3.zoom().on("zoom", function () {
          //     svg.attr("transform", d3.event.transform);
          //   })
          // );

          var row = grid
            .selectAll(".row")
            .data(gridData)
            .enter()
            .append("g")
            .attr("class", "row");

          var column = row
            .selectAll(".square")
            .data(function (d) {
              return d;
            })
            .enter()
            .append("rect")
            .attr("class", "square")
            .attr("x", function (d) {
              return d.x;
            })
            .attr("y", function (d) {
              return d.y;
            })
            .attr("width", function (d) {
              return d.width;
            })
            .attr("height", function (d) {
              return d.height;
            })
            .attr("padding", function (d) {
              return "10px";
            })
            .style("fill", function (d) {
              return d.color;
            }) //"#fff")
            .style("stroke", "#222")
            .on("mouseover", mouseOver)
            .on("mouseout", mouseLeave)
            .on("click", function (d) {
              d.click++;
              if (d.click % 4 == 0) {
                d3.select(this).style("fill", "#fff");
              }
              if (d.click % 4 == 1) {
                d3.select(this).style("fill", "#2C93E8");
              }
              if (d.click % 4 == 2) {
                d3.select(this).style("fill", "#F56C4E");
              }
              if (d.click % 4 == 3) {
                d3.select(this).style("fill", "#838690");
              }
            });

          var word_cloud = d3
            .select("#words")
            .append("svg")
            .attr("width", "1000px")
            .attr("height", "510px");

          var width = 1000;
          var height = 510;

          var first_terms = getDataByColor(
            gridData[0][0].color.l,
            gridData[0][0].color.a,
            gridData[0][0].color.b,
            mycolor,
            chipTermDict,
            termAbbrevTermDict
          ).all_terms;

          var colorWords = getListofTerms(first_terms);

          var layout = d3.layout
            .cloud()
            .size([width, height])
            .words(
              colorWords.map(function (d) {
                return {
                  text: d,
                  // size: Math.random() * 100,
                };
              })
            )
            .padding(5)
            .fontSize(20)
            // .font("Twentieth Century Light")
            .on("end", draw);
          layout.start();

          function draw(words) {
            word_cloud
              .append("g")
              .attr(
                "transform",
                "translate(" +
                  layout.size()[0] / 2 +
                  "," +
                  layout.size()[1] / 2 +
                  ")"
              )
              .selectAll("text")
              .data(words)
              .enter()
              .append("text")
              .style("font-size", function (d) {
                return d.size + "px";
              })
              .attr("text-anchor", "middle")
              .attr("transform", function (d) {
                return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
              })
              .text(function (d) {
                return d.text;
              });
          }

          function updateWordMap(colorWords) {
            console.log("colorwords in update", colorWords);
            layout
              .size([width, height])
              .words(
                colorWords.map(function (d) {
                  return {
                    text: d,
                    // size: Math.random() * 100,
                  };
                })
              )
              .padding(5)
              .fontSize(20)
              // .font("helvetica")
              .on("end", updateCloud);
            layout.start();
          }

          function updateCloud(colorWords) {
            word_cloud.selectAll("text").remove();
            word_cloud
              .append("g")
              .attr(
                "transform",
                "translate(" +
                  layout.size()[0] / 2 +
                  "," +
                  layout.size()[1] / 2 +
                  ")"
              )
              .selectAll("text")
              .data(colorWords)
              .enter()
              .append("text")
              .transition()
              .duration(50)
              .style("font-size", function (d) {
                return d.size + "px";
              })
              .attr("text-anchor", "middle")
              .attr("transform", function (d) {
                return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
              })
              .text(function (d) {
                return d.text;
              });
          }
        }
      );
  </script>

  <script>
  // The svg
  var svg = d3.select("svg"),
    width = +svg.attr("width"),
    height = +svg.attr("height");

  // Map and projection
  var path = d3.geoPath();
  var projection = d3.geoMercator()
    .scale(150)
    .center([0,20])
    .translate([width / 2, height / 2]);

  // Data and color scale
  var data = d3.map();
  var colorScale = d3.scaleThreshold()
    .domain([10, 25, 50, 75, 100, 125, 150, 175, 200])
    .range(d3.schemeBlues[7]);

  // Load external data and boot
  d3.queue()
    .defer(d3.json, "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson")
    .defer(d3.csv, "data/male_female_ratio.csv", function(d) { data.set(d.code, +d.pop); })
    .await(ready);

  function ready(error, topo) {

    let mouseOver = function(d) {
      d3.selectAll(".Country")
        .transition()
        .duration(200)
        .style("opacity", .5)
      d3.select(this)
        .transition()
        .duration(200)
        .style("opacity", 1)
        .style("stroke", "black")
    }

    let mouseLeave = function(d) {
      d3.selectAll(".Country")
        .transition()
        .duration(200)
        .style("opacity", .8)
      d3.select(this)
        .transition()
        .duration(200)
        .style("stroke", "transparent")
    }

    // Draw the map
    svg.append("g")
      .selectAll("path")
      .data(topo.features)
      .enter()
      .append("path")
        // draw each country
        .attr("d", d3.geoPath()
          .projection(projection)
        )
        // set the color of each country
        .attr("fill", function (d) {
          d.total = data.get(d.id) || 0;
          return colorScale(d.total);
        })
        .style("stroke", "transparent")
        .attr("class", function(d){ return "Country" } )
        .style("opacity", .8)
        .on("mouseover", mouseOver )
        .on("mouseleave", mouseLeave )
      }

  </script>

</html>
